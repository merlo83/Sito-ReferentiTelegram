<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accesso Gruppo Referenti</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        /* Impostazioni globali e Sfondo */
        body, html { margin: 0; padding: 0; min-height: 100%; background-color: #000; color: #c9d1d9; font-family: 'Roboto Mono', monospace; }
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .container { position: relative; z-index: 2; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; text-align: center; max-width: 600px; margin: 0 auto; text-shadow: 0 0 5px #000, 0 0 10px #000; }
        h1 { color: #ffffff; font-size: 2.2em; border-right: 2px solid rgba(0, 255, 0, .75); white-space: nowrap; overflow: hidden; margin: 0 auto; animation: typing 3.5s steps(40, end) forwards, blink-caret .75s step-end infinite; }
        h2 { color: #ffffff; font-size: 1.6em; margin-top: 10px; margin-bottom: 20px; font-weight: 700; }
        p { font-size: 1.1em; line-height: 1.6; color: #c9d1d9; }
        .contact-info { margin-top: 25px; }
        .contact-info a { color: #2AABEE; text-decoration: none; font-size: 1.1em; font-weight: 700; }
        .contact-info a:hover { text-decoration: underline; }
        .cta-button { display: inline-block; background-color: #238636; color: #ffffff; font-weight: 700; text-decoration: none; padding: 15px 30px; font-size: 1.2em; border-radius: 6px; margin-top: 30px; transition: background-color 0.3s ease, transform 0.3s ease; cursor: pointer; border: none; }
        .cta-button:hover { background-color: #2ea043; transform: scale(1.05); }
        .stats-container { border-top: 1px solid #30363d; width: 100%; margin-top: 35px; padding: 25px 10px; font-size: 0.9em; background-color: rgba(0, 0, 0, 0.6); border-radius: 8px; color: #FFFFFF; font-weight: 700; }
        .stats-box { display: inline-block; margin: 0 15px; }
        .stats-box span { display: block; font-size: 1.8em; color: #FFFFFF; font-weight: 700; margin-top: 5px; }
        .loading { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: rgba(0, 255, 0, .75); } }

        /* --- ▼▼▼ NUOVO CSS PER VERIFICA CIP ▼▼▼ --- */
        #verification-section {
            border-top: 1px solid #30363d;
            width: 100%;
            margin-top: 35px;
            padding-top: 25px;
        }
        #verification-section h3 {
             color: #ffffff;
             font-size: 1.3em;
             margin-bottom: 15px;
        }
        #cip-input {
            font-family: 'Roboto Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 6px;
            width: 70%;
            max-width: 250px;
            text-align: center;
            margin-right: 10px;
        }
        #verify-button { /* Usa lo stesso stile del pulsante CTA */
            padding: 10px 20px;
            font-size: 1em;
        }
        #verification-result {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(13, 17, 23, 0.8); /* Sfondo scuro trasparente */
            border: 1px solid #30363d;
            border-radius: 6px;
            min-height: 50px; /* Altezza minima per vedere il loading */
            line-height: 1.6;
            color: #c9d1d9;
            text-align: left; /* Allinea a sinistra i risultati */
        }
        #verification-result strong { color: #ffffff; }
        /* Stili per i messaggi di stato */
        .status-ok { color: #238636; font-weight: bold; } /* Verde */
        .status-pending { color: #FFA500; font-weight: bold; } /* Arancione */
        .status-rejected { color: #f85149; font-weight: bold; } /* Rosso */
        .status-error { color: #f85149; font-weight: bold; } /* Rosso */
        /* --- ▲▲▲ FINE CSS VERIFICA CIP ▲▲▲ --- */

        /* Correzione per Mobile */
        @media (max-width: 600px) {
            .container { justify-content: flex-start; padding-top: 10vh; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.3em; }
            p { font-size: 1.0em; }
            .stats-box { margin: 5px 10px; }
            #cip-input { width: 60%; margin-right: 5px; }
            #verify-button { padding: 10px 15px; }
        }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2KBE63SN7L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2KBE63SN7L');
    </script>

</head>
<body>

    <canvas id="matrix-canvas"></canvas>

    <div class="container">
        <h1 id="title"></h1>
        <h2>Gruppo Referenti Informatici</h2>
        <p>
            Pagina di registrazione riservata ai Referenti Informatici e Tecnici Telematici.
            Premi il pulsante per avviare la procedura di autenticazione.
        </p>
        <div class="contact-info">
            <a href="https://t.me/merlo83" target="_blank">Contatto Admin: @merlo83</a>
        </div>
        <a href="https://forms.gle/teQPA9cjgtQrojdh9" class="cta-button">
            INIZIA REGISTRAZIONE
        </a>

        <div class="stats-container">
            <div class="stats-box">
                Utenti Registrati:
                <span id="stats-registrati" class="loading">...</span>
            </div>
            <div class="stats-box">
                Utenti In Attesa:
                <span id="stats-in-attesa" class="loading">...</span>
            </div>
        </div>

        <div id="verification-section">
            <h3>Verifica Registrazione</h3>
            <div>
                <input type="text" id="cip-input" placeholder="Inserisci CIP (es. 123456AB)" maxlength="8">
                <button id="verify-button" class="cta-button">Verifica</button>
            </div>
            <div id="verification-result" style="display: none;"></div> </div>
        </div>

    <script>
        // --- Script #1: Effetto "macchina da scrivere" ---
        const textToType = "> Accesso Area Riservata";
        const titleElement = document.getElementById('title');
        let index = 0; let speed = 80;
        function typeWriter() { /* ... (codice invariato) ... */ if (index < textToType.length) { titleElement.innerHTML += textToType.charAt(index); index++; setTimeout(typeWriter, speed); } }
        window.addEventListener('load', typeWriter);

        // --- Script #2: Effetto "Matrix Rain" ---
        const canvas = document.getElementById('matrix-canvas'); /* ... (codice invariato) ... */ const ctx = canvas.getContext('2d'); canvas.width = window.innerWidth; canvas.height = window.innerHeight; window.addEventListener('resize', () => { /* ... */ }); let katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン'; let chars = katakana + '0123456789'; chars = chars.split(''); const fontSize = 14; let columns = canvas.width / fontSize; let drops = []; for(let x = 0; x < columns; x++) { drops[x] = 1; } function drawMatrix() { /* ... */ ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#0F0'; ctx.font = fontSize + 'px ' + 'Roboto Mono'; for(let i = 0; i < drops.length; i++) { const text = chars[Math.floor(Math.random() * chars.length)]; ctx.fillText(text, i * fontSize, drops[i] * fontSize); if(drops[i] * fontSize > canvas.height && Math.random() > 0.975) { drops[i] = 0; } drops[i]++; } } setInterval(drawMatrix, 33);

        // --- Script #3: STATISTICHE e VERIFICA CIP ---

        // Incolla qui l'URL della tua Web App
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxk0v9Tk1pVB7evv-KyRll436aWrITUupHAVxSs3AebxayY6KMa90WlUMjAqko1k-QK/exec"; // <--- !!!! MODIFICA QUESTO !!!!

        // Elementi per le statistiche
        const registratiEl = document.getElementById('stats-registrati');
        const inAttesaEl = document.getElementById('stats-in-attesa');
        
        // Elementi per la verifica CIP
        const cipInput = document.getElementById('cip-input');
        const verifyButton = document.getElementById('verify-button');
        const verificationResultEl = document.getElementById('verification-result');

        // Funzione per caricare le statistiche
        async function caricaStatistiche() {
            // ... (codice invariato per caricare statistiche) ...
            if (WEB_APP_URL.includes("....")) { console.error("URL Web App non configurato."); registratiEl.innerText = "Errore"; inAttesaEl.innerText = "Conf."; /*...*/ return; }
            try {
                // Aggiungiamo un parametro per dire allo script cosa vogliamo
                const response = await fetch(WEB_APP_URL + '?action=stats'); 
                if (!response.ok) { throw new Error(`Errore HTTP: ${response.status}`); }
                const data = await response.json();
                if (data.errore) { throw new Error(data.errore); }
                if (data.tipo !== 'statistiche') { throw new Error("Risposta non valida dal server (tipo errato)"); }

                registratiEl.innerText = data.utenti_registrati;
                inAttesaEl.innerText = data.utenti_in_attesa;
                registratiEl.classList.remove('loading');
                inAttesaEl.classList.remove('loading');
            } catch (error) { /* ... (gestione errore invariata) ... */ console.error("Errore caricamento statistiche:", error); registratiEl.innerText = "N/D"; inAttesaEl.innerText = "N/D"; /*...*/ }
        }

        // Funzione per gestire la verifica del CIP
        async function verificaCIP() {
            const cip = cipInput.value.trim().toUpperCase(); // Prendiamo il CIP e lo mettiamo in maiuscolo
            verificationResultEl.style.display = 'block'; // Mostra l'area risultati
            verificationResultEl.innerHTML = '<span class="loading">Verifica in corso...</span>';
            verificationResultEl.className = ''; // Resetta classi colore

            // Validazione formato CIP (lato client)
            if (!/^[0-9]{6}[A-Z]{2}$/.test(cip)) {
                 verificationResultEl.innerHTML = "Formato CIP non valido. Inserisci 6 numeri seguiti da 2 lettere (es. 123456AB).";
                 verificationResultEl.className = 'status-error';
                 return;
            }

            if (WEB_APP_URL.includes("....")) {
                 verificationResultEl.innerHTML = "Errore di configurazione. Contattare l'admin.";
                 verificationResultEl.className = 'status-error';
                 return;
            }

            try {
                 // Usiamo JSONP per chiamare la Web App da GitHub Pages
                 const callbackName = 'jsonp_callback_' + Date.now();
                 const script = document.createElement('script');
                 script.src = `${WEB_APP_URL}?action=verify&cip=${encodeURIComponent(cip)}&callback=${callbackName}`;

                 // Definiamo la funzione di callback globale
                 window[callbackName] = function(data) {
                     // Pulizia: rimuoviamo lo script e la funzione callback
                     document.body.removeChild(script);
                     delete window[callbackName];

                     if (data.errore) {
                         throw new Error(data.errore);
                     }
                     if (data.tipo !== 'verifica') {
                         throw new Error("Risposta non valida dal server.");
                     }

                     if (data.trovato) {
                         // Formatta i risultati
                         let htmlRisultato = `<strong>Registrazione Trovata:</strong><br>` +
                                             `Grado: ${data.grado}<br>` +
                                             `Cognome: ${data.cognome}<br>` +
                                             `Nome: ${data.nome}<br>` +
                                             `Sede: ${data.sede}<br>` +
                                             `Data Reg.: ${data.data_registrazione}<br>`;
                         
                         // Aggiungi lo stato con il colore giusto
                         let statusClass = '';
                         if (data.stato.includes('Confermata')) statusClass = 'status-ok';
                         else if (data.stato.includes('Incompleta')) statusClass = 'status-rejected';
                         else if (data.stato.includes('Attesa')) statusClass = 'status-pending';
                         
                         htmlRisultato += `Stato: <span class="${statusClass}">${data.stato}</span>`;
                         
                         verificationResultEl.innerHTML = htmlRisultato;

                     } else {
                         verificationResultEl.innerHTML = data.messaggio; // Messaggio "CIP non trovato" o "Formato non valido"
                         verificationResultEl.className = 'status-error';
                     }
                 };

                 // Aggiungiamo lo script alla pagina per avviare la chiamata JSONP
                 document.body.appendChild(script);

                 // Timeout di sicurezza nel caso la chiamata fallisca
                 setTimeout(() => {
                      if (window[callbackName]) { // Se la callback esiste ancora dopo X secondi, c'è stato un errore
                           console.error("Timeout chiamata Web App");
                           verificationResultEl.innerHTML = "Errore durante la verifica. Riprova più tardi.";
                           verificationResultEl.className = 'status-error';
                           document.body.removeChild(script);
                           delete window[callbackName];
                      }
                 }, 10000); // 10 secondi timeout

            } catch (error) {
                 console.error("Errore verifica CIP:", error);
                 verificationResultEl.innerHTML = "Errore durante la verifica. Riprova più tardi.";
                 verificationResultEl.className = 'status-error';
            }
        }

        // Associa la funzione al pulsante
        verifyButton.addEventListener('click', verificaCIP);
        // Permetti l'invio anche premendo Invio nel campo CIP
        cipInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                verificaCIP();
            }
        });
        
        // Avvia il caricamento delle statistiche quando la pagina è pronta
        window.addEventListener('load', caricaStatistiche);
        
    </script>

</body>
</html>
